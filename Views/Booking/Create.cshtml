@model DesertPaths.ViewModels.CreateBookingViewModel
@using DesertPaths.Models.Enums
@{
    ViewData["Title"] = "Book " + Model.JourneyTitle;
}

<section class="hero" style="min-height: 40vh; background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('@(Model.HeroImageUrl ?? "https://images.unsplash.com/photo-1547234935-80c7145ec969?w=1920&h=1080&fit=crop")'); background-size: cover; background-position: center;">
    <div class="hero-content">
        <p style="color: var(--sand-300); margin-bottom: 0.5rem;">@Model.LandName</p>
        <h1 class="hero-title" style="font-size: 2.5rem;">Book: @Model.JourneyTitle</h1>
        <p class="hero-subtitle">@Model.DurationDays days / @Model.DurationNights nights</p>
    </div>
</section>

<section class="section">
    <div class="container" style="max-width: 900px;">
        <form asp-action="Create" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="JourneyId" />

            <style>
                @@media (min-width: 768px) {
                    .booking-grid { grid-template-columns: 1.5fr 1fr !important; }
                }
            </style>

            <div class="booking-grid" style="display: grid; grid-template-columns: 1fr; gap: 2rem;">
                <!-- Booking Form -->
                <div>
                    <div class="card" style="padding: 2rem;">
                        <h2 style="font-weight: 600; margin-bottom: 1.5rem;">Booking Details</h2>

                        @if (!ViewData.ModelState.IsValid)
                        {
                            <div style="background-color: #fee2e2; border: 1px solid #fecaca; color: #991b1b; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                                <strong>Please correct the following errors:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                    {
                                        <li>@error.ErrorMessage</li>
                                    }
                                </ul>
                            </div>
                        }

                        <!-- Travel Style -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.75rem;">Travel Style *</label>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                @foreach (var style in Model.AvailableStyles)
                                {
                                    <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" 
                                           class="style-option" data-price="@style.CalculatedPrice">
                                        <input type="radio" asp-for="StyleId" value="@style.Id" 
                                               style="margin-top: 0.25rem;" 
                                               onchange="updatePrice()" />
                                        <div style="flex: 1;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <strong>@style.Name</strong>
                                                <span style="color: var(--desert-600); font-weight: 600;">$@style.CalculatedPrice.ToString("N0")/person</span>
                                            </div>
                                            <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">@style.Description</p>
                                        </div>
                                    </label>
                                }
                            </div>
                            <span asp-validation-for="StyleId" style="color: #dc2626; font-size: 0.875rem;"></span>
                        </div>

                        <!-- Travel Date -->
                        <div style="margin-bottom: 1.5rem;">
                            <label asp-for="TravelDate" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Travel Date *</label>
                            <input asp-for="TravelDate" type="date" 
                                   min="@DateTime.Today.AddDays(7).ToString("yyyy-MM-dd")"
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;" />
                            <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Must be at least 7 days from today</p>
                            <span asp-validation-for="TravelDate" style="color: #dc2626; font-size: 0.875rem;"></span>
                        </div>

                        <!-- Number of Guests -->
                        <div style="margin-bottom: 1.5rem;">
                            <label asp-for="NumberOfGuests" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Number of Guests *</label>
                            <input asp-for="NumberOfGuests" type="number" min="1" max="@Model.MaxGroupSize"
                                   onchange="updatePrice()"
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;" />
                            <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Maximum @Model.MaxGroupSize guests per booking</p>
                            <span asp-validation-for="NumberOfGuests" style="color: #dc2626; font-size: 0.875rem;"></span>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="card" style="padding: 2rem; margin-top: 1.5rem;">
                        <h2 style="font-weight: 600; margin-bottom: 1.5rem;">Contact Information</h2>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <label asp-for="ContactEmail" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Email *</label>
                                <input asp-for="ContactEmail" type="email"
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;" />
                                <span asp-validation-for="ContactEmail" style="color: #dc2626; font-size: 0.875rem;"></span>
                            </div>
                            <div>
                                <label asp-for="ContactPhone" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Phone *</label>
                                <input asp-for="ContactPhone" type="tel" placeholder="+966 5X XXX XXXX"
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;" />
                                <span asp-validation-for="ContactPhone" style="color: #dc2626; font-size: 0.875rem;"></span>
                            </div>
                        </div>

                        <!-- Special Requests -->
                        <div>
                            <label asp-for="SpecialRequests" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Special Requests (Optional)</label>
                            <textarea asp-for="SpecialRequests" rows="3" 
                                      placeholder="Any dietary requirements, accessibility needs, or special occasions..."
                                      style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; resize: vertical;"></textarea>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="card" style="padding: 2rem; margin-top: 1.5rem;">
                        <h2 style="font-weight: 600; margin-bottom: 1.5rem;">Payment Method</h2>

                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" 
                                   class="payment-option" id="payment-online">
                                <input type="radio" asp-for="PaymentMethod" value="@PaymentMethod.Online" 
                                       style="margin-top: 0.25rem;" checked onchange="updatePaymentOption()" />
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <strong>Pay Online Now</strong>
                                        <span style="background-color: #d1fae5; color: #065f46; font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 9999px;">Recommended</span>
                                    </div>
                                    <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">Secure payment via PayTabs. Your booking will be confirmed immediately.</p>
                                </div>
                            </label>

                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" 
                                   class="payment-option" id="payment-arrival">
                                <input type="radio" asp-for="PaymentMethod" value="@PaymentMethod.OnArrival" 
                                       style="margin-top: 0.25rem;" onchange="updatePaymentOption()" />
                                <div style="flex: 1;">
                                    <strong>Pay on Arrival</strong>
                                    <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">Pay in cash or card when you arrive. Our team will contact you to confirm your booking.</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div>
                    <div class="card" style="padding: 1.5rem; position: sticky; top: 5rem;">
                        <h3 style="font-weight: 600; margin-bottom: 1rem;">Order Summary</h3>

                        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1rem;">
                            <p style="font-weight: 600;">@Model.JourneyTitle</p>
                            <p style="font-size: 0.875rem; color: #6b7280;">@Model.LandName â€¢ @Model.DurationDays days</p>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                                <span>Base price per person</span>
                                <span>$@Model.BasePrice.ToString("N0")</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                                <span>Style multiplier</span>
                                <span id="styleMultiplier">1.0x</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                                <span>Number of guests</span>
                                <span id="guestCount">1</span>
                            </div>
                        </div>

                        <div style="border-top: 2px solid #e5e7eb; padding-top: 1rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600; font-size: 1.125rem;">Total</span>
                                <span id="totalPrice" style="font-family: 'Playfair Display', serif; font-size: 1.5rem; font-weight: 700; color: var(--desert-600);">
                                    $@Model.BasePrice.ToString("N0")
                                </span>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary" style="width: 100%; text-align: center; font-size: 1rem; padding: 1rem;" id="submitBtn">
                            Continue to Payment
                        </button>

                        <p style="font-size: 0.75rem; color: #6b7280; text-align: center; margin-top: 1rem;">
                            Free cancellation up to 14 days before departure
                        </p>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

@section Scripts {
    <script>
        const basePrice = @Model.BasePrice;
        const styles = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.AvailableStyles.Select(s => new { s.Id, s.PriceMultiplier })));

        function updatePrice() {
            const selectedStyle = document.querySelector('input[name="StyleId"]:checked');
            const guests = parseInt(document.getElementById('NumberOfGuests').value) || 1;

            let multiplier = 1.0;
            if (selectedStyle) {
                const styleData = styles.find(s => s.Id == selectedStyle.value);
                if (styleData) {
                    multiplier = styleData.PriceMultiplier;
                }
            }

            const total = basePrice * multiplier * guests;

            document.getElementById('styleMultiplier').textContent = multiplier.toFixed(1) + 'x';
            document.getElementById('guestCount').textContent = guests;
            document.getElementById('totalPrice').textContent = '$' + total.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

            // Highlight selected style
            document.querySelectorAll('.style-option').forEach(el => {
                el.style.borderColor = '#e5e7eb';
                el.style.backgroundColor = 'white';
            });
            if (selectedStyle) {
                selectedStyle.closest('.style-option').style.borderColor = 'var(--desert-600)';
                selectedStyle.closest('.style-option').style.backgroundColor = 'var(--desert-50)';
            }
        }

        function updatePaymentOption() {
            const payOnline = document.querySelector('input[name="PaymentMethod"][value="0"]');
            const submitBtn = document.getElementById('submitBtn');

            document.querySelectorAll('.payment-option').forEach(el => {
                el.style.borderColor = '#e5e7eb';
                el.style.backgroundColor = 'white';
            });

            if (payOnline && payOnline.checked) {
                document.getElementById('payment-online').style.borderColor = 'var(--desert-600)';
                document.getElementById('payment-online').style.backgroundColor = 'var(--desert-50)';
                submitBtn.textContent = 'Continue to Payment';
            } else {
                document.getElementById('payment-arrival').style.borderColor = 'var(--desert-600)';
                document.getElementById('payment-arrival').style.backgroundColor = 'var(--desert-50)';
                submitBtn.textContent = 'Confirm Booking';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updatePrice();
            updatePaymentOption();
        });
    </script>
}
